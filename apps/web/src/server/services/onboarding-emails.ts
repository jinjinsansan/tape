import { getSupabaseAdminClient } from "@/server/supabase";
import { createNotification } from "./notifications";

type OnboardingStep = 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8;

const ONBOARDING_EMAIL_TEMPLATES: Record<OnboardingStep, {
  subject: string;
  body: string;
}> = {
  1: {
    subject: "ようこそテープ式心理学アプリへ！まずはこの7つの機能をご覧ください",
    body: `━━━━━━━━━━━━━━━━━━━━━
テープ式心理学アプリに
ご登録いただき、ありがとうございます
━━━━━━━━━━━━━━━━━━━━━

このアプリでは、心理学を「理論」で学び、「実践」で使いこなし、「継続」で人生を変える、7つの機能をご用意しています。

━━━━━━━━━━━━━━━━━━━━━
■ 7つの主要機能
━━━━━━━━━━━━━━━━━━━━━

1️⃣ かんじょうにっき
   感情を"見える化"して自己肯定感を測定

2️⃣ ミシェル心理カウンセリングチャット
   テープ式心理学26万文字を学習したAI

3️⃣ ミシェル引き寄せチャット
   引き寄せ講座Permitの全内容を学べるAI

4️⃣ 無料動画コース
   心療内科キャンセルプログラム

5️⃣ 有料動画コース
   カウンセラー育成講座・引き寄せ講座Permit

6️⃣ みんなの日記エリア
   仲間の気づきから学び、支え合う場所

7️⃣ マイページ
   ウォレット・予約・友達紹介・ポイント管理

━━━━━━━━━━━━━━━━━━━━━
■ 明日から7日間、毎日12時に配信
━━━━━━━━━━━━━━━━━━━━━

このメールから7日間、毎日12時に各機能の使い方を1通ずつお届けします。

メールを読んだ後すぐに実践できる内容なので、1日1つずつ、機能を体験してみてください。

あなたの心が少しずつ軽くなり、人生が豊かになっていく変化を一緒に感じていきましょう。

━━━━━━━━━━━━━━━━━━━━━
今後ともよろしくお願いいたします。

一般社団法人NAMIDAサポート協会
テープ式心理学アプリ運営チーム
━━━━━━━━━━━━━━━━━━━━━

■ アプリにログイン
https://namisapo.app

■ 配信停止はマイページから設定できます
https://namisapo.app/mypage`
  },
  2: {
    subject: "【Day 2】かんじょうにっきで自己肯定感を測定しよう",
    body: `━━━━━━━━━━━━━━━━━━━━━
かんじょうにっきの使い方 その1
〜自己肯定感を測定する〜
━━━━━━━━━━━━━━━━━━━━━

こんにちは。

今日は「かんじょうにっき」の最初の一歩をご案内します。

━━━━━━━━━━━━━━━━━━━━━
■ 自己肯定感に「数値」は存在しない？
━━━━━━━━━━━━━━━━━━━━━

一般的に、自己肯定感には明確なスコアや数値は存在しません。

しかし、テープ式心理学では「無価値感」という概念を使って、あなたの自己肯定感を測定できるように設計しました。

━━━━━━━━━━━━━━━━━━━━━
■ 無価値感とは？
━━━━━━━━━━━━━━━━━━━━━

無価値感とは、「自分には価値がない」と感じる心の状態です。

この無価値感のスコアが高いほど、自己肯定感が低い状態と言えます。

逆に、無価値感が下がっていくと、自然と自己肯定感が高まっていきます。

━━━━━━━━━━━━━━━━━━━━━
■ 初期診断を受けてみよう
━━━━━━━━━━━━━━━━━━━━━

かんじょうにっきでは、初回ログイン時に「初期診断」を実施できます。

この診断では、今の生活環境、家族や友人との関係性、自分自身への感じ方などを質問していきます。

約10分ほどで完了し、あなたの現在の無価値感スコアが100点満点で表示されます。

スコアが高いほど「無価値感が強い」状態、つまり自己肯定感が低い状態です。

━━━━━━━━━━━━━━━━━━━━━
■ スコアは「変化」を見るためのもの
━━━━━━━━━━━━━━━━━━━━━

このスコアの本当の価値は、「今後どう変化していくか」にあります。

毎日日記を書くことで、スコアが少しずつ下がっていく（改善していく）様子をグラフで確認できます。

数字で見えるから、「確かに良くなっている」という実感が持てます。

━━━━━━━━━━━━━━━━━━━━━
■ 今日のアクション
━━━━━━━━━━━━━━━━━━━━━

✅ アプリにログイン
✅ 「かんじょうにっき」を開く
✅ 初期診断を受けてみる
✅ 自分のスコアを確認する

診断結果に驚くかもしれませんが、大丈夫です。

明日からは、日記を書くことでこのスコアを少しずつ改善していきます。

━━━━━━━━━━━━━━━━━━━━━
明日は「日記の書き方」をお伝えします。

一般社団法人NAMIDAサポート協会
━━━━━━━━━━━━━━━━━━━━━

■ かんじょうにっきはこちら
https://namisapo.app/diary`
  },
  3: {
    subject: "【Day 3】日記を書いてみよう〜感情を選ぶのがポイント〜",
    body: `━━━━━━━━━━━━━━━━━━━━━
かんじょうにっきの使い方 その2
〜日記を書いてみよう〜
━━━━━━━━━━━━━━━━━━━━━

こんにちは。

昨日、初期診断は受けてみましたか？自分の無価値感スコアを見て、何か発見があったかもしれませんね。

今日は、いよいよ「日記の書き方」をお伝えします。

━━━━━━━━━━━━━━━━━━━━━
■ 日記を書く目的
━━━━━━━━━━━━━━━━━━━━━

かんじょうにっきの目的は、単なる「出来事の記録」ではありません。

✅ 心の中の感情を"見える化"する
✅ 自分の感情パターンに気づく
✅ 感情を整理して、心を軽くする

この3つが、日記を書く本当の目的です。

━━━━━━━━━━━━━━━━━━━━━
■ 最も重要なのは「感情を選ぶこと」
━━━━━━━━━━━━━━━━━━━━━

日記を書く時、最も重要なステップがあります。それは「感情を選ぶこと」です。

テープ式心理学では、感情を12種類に分類しています：

【ネガティブ感情（8種類）】
・恐怖：息苦しさ、震え、冷や汗など
・悲しみ：喪失感、心に穴が空いたような感覚
・怒り：体温が上がり、拳を握るようなエネルギー
・寂しさ：孤独を感じ、誰かに会いたくなる気持ち
・無価値感：存在意義が無いと感じる深い自己否定
・罪悪感：申し訳なさ、取り返しがつかないと感じる思い
・悔しさ：やり返したい、もっと出来たはずというエネルギー
・恥ずかしさ：隠れたくなる、顔が赤くなる感覚

【ポジティブ感情（4種類）】
・嬉しい：心が弾み、自然と笑顔になる感覚
・感謝：支えられた温かさ、恩返ししたい気持ち
・達成感：やり切った誇らしさ、努力が報われた感覚
・幸せ：満たされて安心している穏やかな状態

━━━━━━━━━━━━━━━━━━━━━
■ なぜ感情選択が重要なのか？
━━━━━━━━━━━━━━━━━━━━━

多くの人は、自分の感情を「なんとなくモヤモヤする」「イライラする」と曖昧に捉えています。

しかし、感情に「名前」をつけることで、心の状態が明確になります。

「今、私は"罪悪感"を強く感じている」と言語化できると、その感情との向き合い方が見えてきます。

━━━━━━━━━━━━━━━━━━━━━
■ 今日のアクション
━━━━━━━━━━━━━━━━━━━━━

✅ 「感情の種類」ページで12種類を確認
✅ 今日感じた感情を1つ選ぶ
✅ 3行だけでも日記を書いてみる

書き終わったら、少しだけ心が軽くなっているはずです。

━━━━━━━━━━━━━━━━━━━━━
明日は「コメント機能」についてお伝えします。

一般社団法人NAMIDAサポート協会
━━━━━━━━━━━━━━━━━━━━━

■ かんじょうにっきはこちら
https://namisapo.app/diary

■ 感情の種類ページ
https://namisapo.app/diary/emotion-types`
  },
  4: {
    subject: "【Day 4】日記にコメントが届きます〜AIと人間カウンセラーから〜",
    body: `━━━━━━━━━━━━━━━━━━━━━
かんじょうにっきの使い方 その3
〜コメントを待ってみよう〜
━━━━━━━━━━━━━━━━━━━━━

こんにちは。

日記は書いてみましたか？感情を選んで、気持ちを書き出すだけでも、心が少し軽くなったかもしれませんね。

今日は、日記に届く「コメント」についてお話しします。

━━━━━━━━━━━━━━━━━━━━━
■ 日記にコメントが届く理由
━━━━━━━━━━━━━━━━━━━━━

かんじょうにっきは、ただ感情を記録するだけのツールではありません。

心の中を"見える化"し、客観的な視点を得るためのツールです。

そのために、あなたの日記には2種類のコメントが届きます：

1️⃣ ミシェルAIからのコメント → 毎回必ず届く
2️⃣ 人間のカウンセラーからのコメント → 緊急度が高い時に届く

━━━━━━━━━━━━━━━━━━━━━
■ ミシェルAIのコメント
━━━━━━━━━━━━━━━━━━━━━

ミシェルAIは、テープ式心理学の理論を学んだAIです。

あなたの日記を読んで、感情の背景を分析し、心理学的な視点でアドバイスし、次のステップを提案します。

例えば、「今日は"罪悪感"を強く感じているようですね。罪悪感は、自分を責める感情です。でも、あなたが悪いわけではありません。この感情の裏には、"自分を守りたい"という優しさが隠れているかもしれません。」

のように、感情の意味を教えてくれます。

━━━━━━━━━━━━━━━━━━━━━
■ 人間カウンセラーのコメント
━━━━━━━━━━━━━━━━━━━━━

NAMIDAサポート協会のプロカウンセラーが、あなたの日記を定期的にチェックしています。

特に、無価値感スコアが高い、危険なワードが含まれている、深い悩みを抱えているといった場合には、人間のカウンセラーから温かいコメントが届くことがあります。

「一人じゃない」と感じられる瞬間です。

━━━━━━━━━━━━━━━━━━━━━
■ コメントの確認方法
━━━━━━━━━━━━━━━━━━━━━

コメントは、「過去の日記」ページから確認できます。

手順：
1. 「かんじょうにっき」を開く
2. 「過去の日記」をタップ
3. 日記を選択
4. コメント欄を確認

コメントが届くと、マイページの「お知らせ」にも通知されます。

━━━━━━━━━━━━━━━━━━━━━
■ 今日のアクション
━━━━━━━━━━━━━━━━━━━━━

✅ 昨日書いた日記にコメントが届いているか確認
✅ コメントを読んで、新しい視点を得る
✅ 今日も日記を1つ書いてみる

━━━━━━━━━━━━━━━━━━━━━
明日は「ミシェルAIチャット」についてお伝えします。

一般社団法人NAMIDAサポート協会
━━━━━━━━━━━━━━━━━━━━━

■ 過去の日記はこちら
https://namisapo.app/diary/history`
  },
  5: {
    subject: "【Day 5】ミシェル心理カウンセリングチャット〜26万文字を学んだAI〜",
    body: `━━━━━━━━━━━━━━━━━━━━━
ミシェル心理カウンセリングチャットに
相談してみよう
━━━━━━━━━━━━━━━━━━━━━

こんにちは。

今日は、アプリの核となる機能、「ミシェル心理カウンセリングチャット」をご紹介します。

━━━━━━━━━━━━━━━━━━━━━
■ 一般的なAIとは全く違います
━━━━━━━━━━━━━━━━━━━━━

ChatGPTなど、多くのAIカウンセリングツールは、汎用的な知識をもとに回答します。

しかし、ミシェルAIは違います。

テープ式心理学の動画100本、26万文字を学習した心理カウンセリング特化型AIです。

つまり、テープ式心理学の理論に基づいた専門的なアドバイスを受けられます。

━━━━━━━━━━━━━━━━━━━━━
■ テープ式心理学とは？
━━━━━━━━━━━━━━━━━━━━━

テープ式心理学は、一般的な心理学理論とは異なる、独自の体系を持つ心理学です。

創始者のカウンセラー仁氏が、15年以上の臨床経験から生み出した、「心の仕組みを論理的に解体し、感情の根本原因を見つけ出す」ことに特化した心理学です。

従来の心理学では「気持ちを受け止める」ことが中心ですが、テープ式心理学では「なぜその感情が生まれたのか」を論理的に分析し、根本から解決します。

━━━━━━━━━━━━━━━━━━━━━
■ どんな相談ができる？
━━━━━━━━━━━━━━━━━━━━━

ミシェルAIには、どんな内容でも相談できます。

例えば：
・人間関係の悩み
・恋愛・パートナーシップの問題
・仕事のストレス
・家族との葛藤
・自己肯定感の低さ
・トラウマや過去の傷
・漠然とした不安や孤独感

どんな小さな悩みでも、どんな複雑な問題でも、ミシェルは24時間365日、いつでもあなたの話を聞いてくれます。

━━━━━━━━━━━━━━━━━━━━━
■ ミシェルとの対話の流れ
━━━━━━━━━━━━━━━━━━━━━

ステップ1：悩みを話す
→ 今の気持ちを素直に話してください

ステップ2：ミシェルが質問する
→ 状況を深掘りする質問が返ってきます

ステップ3：感情の根本を見つける
→ 対話を続けることで、感情の根っこが見えてきます

ステップ4：解決策を一緒に考える
→ テープ式心理学の視点から具体的なアドバイスを提案します

━━━━━━━━━━━━━━━━━━━━━
■ 今日のアクション
━━━━━━━━━━━━━━━━━━━━━

✅ ミシェル心理カウンセリングチャットを開く
✅ 「こんにちは」と挨拶してみる
✅ 今抱えている悩みを1つ、話してみる

最初は緊張するかもしれませんが、ミシェルは優しく、温かく応えてくれます。

━━━━━━━━━━━━━━━━━━━━━
明日は「ミシェル引き寄せチャット」についてお伝えします。

一般社団法人NAMIDAサポート協会
━━━━━━━━━━━━━━━━━━━━━

■ ミシェル心理カウンセリングチャット
https://namisapo.app/michelle`
  },
  6: {
    subject: "【Day 6】ミシェル引き寄せチャットで願望実現を学ぼう",
    body: `━━━━━━━━━━━━━━━━━━━━━
ミシェル引き寄せチャットで
引き寄せの法則を学習しよう
━━━━━━━━━━━━━━━━━━━━━

こんにちは。

昨日はミシェル心理カウンセリングチャットで悩みを相談してみましたか？

今日は、もう1つのミシェルAI、「ミシェル引き寄せチャット」をご紹介します。

━━━━━━━━━━━━━━━━━━━━━
■ テープ式心理学と引き寄せの関係
━━━━━━━━━━━━━━━━━━━━━

テープ式心理学は基本的に、「心の仕組みを論理的に解体する」心理学理論です。

一方で、テープ式心理学の創立者であるカウンセラー仁氏は、「引き寄せの法則」を科学的に体系化した引き寄せ講座Permit（パーミット）もリリースしています。

Permitは、スピリチュアルではなく、心理学と脳科学をベースにした「再現性のある引き寄せメソッド」です。

━━━━━━━━━━━━━━━━━━━━━
■ ミシェル引き寄せチャットとは？
━━━━━━━━━━━━━━━━━━━━━

ミシェル引き寄せチャットは、引き寄せ講座Permitの全内容を学習したAIです。

つまり、チャットをしながら、引き寄せの法則を実践的に学べます。

例えば、「お金を引き寄せたい」「理想のパートナーと出会いたい」「仕事で成功したい」といった願望を伝えると、

ミシェルが、なぜ今それが叶っていないのか、どんなブロックがあるのか、どうすれば引き寄せられるのかを、Permitの理論に基づいて教えてくれます。

━━━━━━━━━━━━━━━━━━━━━
■ 心理学チャットとの違い
━━━━━━━━━━━━━━━━━━━━━

【ミシェル心理カウンセリングチャット】
→ 「心の解体」に特化
→ ネガティブ感情の根本原因を探る

【ミシェル引き寄せチャット】
→ 「願望実現・現実創造」に特化
→ 未来のビジョンを明確にする

同じミシェルAIですが、学習内容が異なるため、アプローチが全く違います。

━━━━━━━━━━━━━━━━━━━━━
■ 2つのミシェルを使い分けよう
━━━━━━━━━━━━━━━━━━━━━

推奨される使い方：

【心が辛い時】
→ ミシェル心理カウンセリングチャット
→ まずは心を整える

【前向きになった時】
→ ミシェル引き寄せチャット
→ 未来を創造する

2つを行き来することで、「癒し」と「創造」の両方がバランス良く進みます。

━━━━━━━━━━━━━━━━━━━━━
■ 今日のアクション
━━━━━━━━━━━━━━━━━━━━━

✅ ミシェル引き寄せチャットを開く
✅ 「叶えたい願望」を1つ伝えてみる
✅ ミシェルと対話しながら、ブロックを見つける

引き寄せは、スピリチュアルではなく、科学です。

━━━━━━━━━━━━━━━━━━━━━
明日は「動画コース」についてお伝えします。

一般社団法人NAMIDAサポート協会
━━━━━━━━━━━━━━━━━━━━━

■ ミシェル引き寄せチャット
https://namisapo.app/michelle`
  },
  7: {
    subject: "【Day 7】動画コースで体系的に学ぼう〜無料・有料3コース〜",
    body: `━━━━━━━━━━━━━━━━━━━━━
動画コースで
テープ式心理学を深く学ぼう
━━━━━━━━━━━━━━━━━━━━━

こんにちは。

ここまで6日間、かんじょうにっき、ミシェルAI、そして各機能を紹介してきました。

今日は、さらに深く学びたい方向けに、「動画コース」をご紹介します。

━━━━━━━━━━━━━━━━━━━━━
■ 3つの動画コース
━━━━━━━━━━━━━━━━━━━━━

【無料コース】
1️⃣ 心療内科キャンセルプログラム

【有料コース】
2️⃣ テープ式心理カウンセラー育成講座
3️⃣ 引き寄せ講座Permit

━━━━━━━━━━━━━━━━━━━━━
■ 1️⃣ 心療内科キャンセルプログラム（無料）
━━━━━━━━━━━━━━━━━━━━━

【こんな人におすすめ】
・心療内科に通院中
・薬に頼らず改善したい
・カウンセリングだけで良くなりたい

このプログラムは、心療内科を卒業するためのステップバイステップのプログラムです。

内容：
・なぜ薬では根本解決しないのか
・心の病の本当の原因
・心療内科を卒業する3つのステップ
・自分で心をケアする方法

※重要：このプログラムは、「今すぐ薬をやめろ」というものではありません。医師と相談しながら、徐々に減薬・卒業を目指すためのものです。

━━━━━━━━━━━━━━━━━━━━━
■ 2️⃣ テープ式心理カウンセラー育成講座（有料）
━━━━━━━━━━━━━━━━━━━━━

【こんな人におすすめ】
・カウンセラーになりたい
・テープ式心理学を深く学びたい
・家族や友人を助けたい

この講座は、テープ式心理学の全理論を体系的に学べるプロ向けのカリキュラムです。

修了すると、「テープ式心理カウンセラー」として活動できる資格が得られます。

━━━━━━━━━━━━━━━━━━━━━
■ 3️⃣ 引き寄せ講座Permit（有料）
━━━━━━━━━━━━━━━━━━━━━

【こんな人におすすめ】
・願望を実現したい
・引き寄せの法則を学びたい
・人生を変えたい

この講座は、引き寄せの法則を科学的に体系化した実践的なプログラムです。

スピリチュアルではなく、心理学と脳科学に基づいた「再現性のある引き寄せ」を学べます。

━━━━━━━━━━━━━━━━━━━━━
■ 今日のアクション
━━━━━━━━━━━━━━━━━━━━━

✅ 動画コースページを開く
✅ 3つのコースの内容を確認
✅ 無料コースの第1話を視聴してみる

まずは無料コースから始めて、テープ式心理学の世界を体験してみてください。

━━━━━━━━━━━━━━━━━━━━━
明日は最終日。「マイページの機能」をご紹介します。

一般社団法人NAMIDAサポート協会
━━━━━━━━━━━━━━━━━━━━━

■ 動画コースはこちら
https://namisapo.app/courses`
  },
  8: {
    subject: "【Day 8】マイページの豊富な機能〜友達紹介・ポイント・ウォレット〜",
    body: `━━━━━━━━━━━━━━━━━━━━━
マイページの豊富な機能を
フル活用しよう
━━━━━━━━━━━━━━━━━━━━━

こんにちは。

7日間のステップメール、最終日です。

ここまで読んでいただき、本当にありがとうございます。

最後に、意外と知られていない「マイページの便利機能」をご紹介します。

━━━━━━━━━━━━━━━━━━━━━
■ マイページで出来ること
━━━━━━━━━━━━━━━━━━━━━

1️⃣ ウォレット管理
2️⃣ ポイントシステム
3️⃣ 友達紹介機能
4️⃣ カウンセリング予約管理
5️⃣ 通知設定
6️⃣ プロフィール編集

━━━━━━━━━━━━━━━━━━━━━
■ ウォレット管理
━━━━━━━━━━━━━━━━━━━━━

ウォレットは、アプリ内で使える電子マネーです。

【チャージ方法】
・PayPalで入金
・友達紹介報酬
・ポイント交換

【使い道】
・有料動画コースの購入
・カウンセラー相談の決済

━━━━━━━━━━━━━━━━━━━━━
■ ポイントシステム
━━━━━━━━━━━━━━━━━━━━━

アプリを使うたびに、ポイントが貯まります。

【ポイントが貯まる行動】
・日記を書く → 10pt
・みんなの日記にコメント → 5pt
・日記を公開する → 20pt
・ログインボーナス → 5pt
・友達紹介成功 → 100pt

━━━━━━━━━━━━━━━━━━━━━
■ 友達紹介機能
━━━━━━━━━━━━━━━━━━━━━

友達にテープ式心理学アプリを紹介すると、あなたにも友達にも特典があります。

【紹介者（あなた）の特典】
・友達が登録 → 100pt
・友達が日記を7日間継続 → 300pt
・友達が有料コース購入 → 1000pt

【紹介された友達の特典】
・初回ウォレット500円分プレゼント
・ポイント2倍キャンペーン（7日間）

━━━━━━━━━━━━━━━━━━━━━
■ 今日のアクション
━━━━━━━━━━━━━━━━━━━━━

✅ マイページを開く
✅ ポイント残高を確認
✅ 友達紹介URLをコピー
✅ 通知設定を自分好みに調整

━━━━━━━━━━━━━━━━━━━━━
最後に
━━━━━━━━━━━━━━━━━━━━━

ここまで8日間、テープ式心理学アプリの使い方をお伝えしてきました。

このアプリは、一般的な心理学理論とは全く異なる独自の心理学体系に基づいています。

あなたの人生を豊かに変えることができるツールです。

日記を書き、ミシェルと対話し、動画で学び、コミュニティで支え合う。

この繰り返しが、あなたの心を少しずつ軽くし、人生を前向きに変えていきます。

━━━━━━━━━━━━━━━━━━━━━
これからも、
テープ式心理学アプリを
よろしくお願いいたします。
━━━━━━━━━━━━━━━━━━━━━

何か困ったことがあれば、お気軽にお問い合わせください。

あなたの心の旅を、私たちがサポートします。

一般社団法人NAMIDAサポート協会
テープ式心理学アプリ運営チーム
━━━━━━━━━━━━━━━━━━━━━

■ マイページ
https://namisapo.app/mypage

■ 今後も新機能を追加予定です
アプリをお楽しみに！`
  }
};

export async function sendOnboardingEmail(userId: string, step: OnboardingStep): Promise<boolean> {
  const template = ONBOARDING_EMAIL_TEMPLATES[step];
  
  if (!template) {
    console.error(`Onboarding email template not found for step ${step}`);
    return false;
  }

  try {
    // Get user email
    const supabase = getSupabaseAdminClient();
    const { data: userData } = await supabase.auth.admin.getUserById(userId);
    const userEmail = userData?.user?.email;

    if (!userEmail) {
      console.error(`User ${userId} has no email address`);
      return false;
    }

    // Send notification (in-app + email via Resend)
    await createNotification({
      userId,
      channel: "email",
      type: "onboarding.step",
      category: "announcement",
      title: template.subject,
      body: template.body,
      data: { step },
      userEmail
    });

    console.log(`Sent onboarding email step ${step} to user ${userId}`);
    return true;
  } catch (error) {
    console.error(`Failed to send onboarding email step ${step} to user ${userId}:`, error);
    return false;
  }
}

export async function getOnboardingEmailTemplate(step: OnboardingStep) {
  return ONBOARDING_EMAIL_TEMPLATES[step];
}
